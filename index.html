<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Docs</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/atropos@2.0.2/atropos.min.css">
    <script src="https://cdn.jsdelivr.net/npm/atropos@2.0.2/atropos.min.js"></script>

    <style>
        :root {
            --bg: #1c1c1c;
            --radius: 30px;
        }

        body {
            background-color: var(--bg);
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
            color: white;
            overflow-x: hidden;
        }

        /* --- ВЕРХНЯЯ ПАНЕЛЬ --- */
        .header {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: rgba(28, 28, 28, 0.95);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .auth-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 600px;
        }

        input {
            flex: 1;
            background: #2c2c2c;
            border: none;
            padding: 15px;
            border-radius: 15px;
            color: white;
            outline: none;
            text-align: center;
        }

        button {
            background: white;
            color: black;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- ЧИСТАЯ СЕТКА (3 колонки) --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* Ровно 3 колонки */
            gap: 15px;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
        }

        .doc-item {
            position: relative;
            aspect-ratio: 1 / 1.4; /* Пропорция паспорта */
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .doc-item:active { transform: scale(0.95); }

        .doc-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* --- ПРОСМОТРЩИК (Overlay) --- */
        #viewer {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* Настройка Atropos (Контейнер перспективы) */
        .my-atropos {
            width: 350px;
            height: 500px; /* Размер закрытого паспорта */
        }
        
        /* Книга внутри Atropos */
        .flip-book {
            width: 100%;
            height: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .page {
            background-color: #fdfdfd;
            overflow: hidden;
            position: relative;
        }

        .page img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Обложка (Красная) */
        .page.--cover {
            background-color: #a00;
        }

        /* --- НАЛОЖЕНИЕ ДАННЫХ --- */
        .data-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            color: #2b2b2b;
        }
        
        .val { position: absolute; transform-origin: top left; }

        /* Координаты для левой страницы */
        .page.--left .val-fio { 
            top: 45%; left: 32%; 
            font-size: 10px; 
            width: 140px;
            transform: rotate(-90deg);
        }

        /* Координаты для правой страницы */
        .page.--right .val-num {
            top: 85%; left: 25%;
            font-size: 14px;
            color: #800;
            transform: rotate(-90deg);
        }

        /* --- МОДАЛКА ДОБАВЛЕНИЯ --- */
        #modal-add {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-box {
            background: #2c2c2c;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="auth-controls">
            <input type="password" id="master-pass" placeholder="Ключ шифрования" oninput="app.renderGrid()">
            <button onclick="document.getElementById('modal-add').style.display='flex'">+</button>
        </div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="modal-add">
        <div class="modal-box">
            <h2 style="margin:0">Новый документ</h2>
            <select id="new-type" style="padding:10px; border-radius:10px; border:none;">
                <option value="passport">Паспорт РФ</option>
                <option value="snils">СНИЛС</option>
            </select>
            <input type="text" id="new-fio" placeholder="ФИО">
            <input type="text" id="new-num" placeholder="Номер / Данные">
            <button onclick="app.addDoc()">Сохранить</button>
            <button onclick="document.getElementById('modal-add').style.display='none'" style="background:#444; color:white">Отмена</button>
        </div>
    </div>

    <div id="viewer" onclick="if(event.target === this) app.closeViewer()">
        
        <div class="atropos my-atropos">
            <div class="atropos-scale">
                <div class="atropos-rotate">
                    <div class="atropos-inner">
                        
                        <div id="book" class="flip-book">
                            </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. CONFIG & DB ---
        const db = new Dexie("SecureVault");
        db.version(1).stores({ docs: '++id, type, data' });

        // URLs картинок (Паспорт разрезан CSS-ом или логически)
        // Для реализма берем обложку и скан разворота
        const ASSETS = {
            passport_cover: 'https://img.freepik.com/premium-photo/russian-passport-isolated-white-background_160606-444.jpg',
            // Качественный скан разворота
            passport_inside: 'http://googleusercontent.com/image_collection/image_retrieval/2937385595549298704_1'
        };

        let currentBook = null;
        let currentAtropos = null;

        const app = {
            // --- CRYPTO ---
            encrypt: (data, pass) => CryptoJS.AES.encrypt(JSON.stringify(data), pass).toString(),
            decrypt: (cipher, pass) => {
                try {
                    const bytes = CryptoJS.AES.decrypt(cipher, pass);
                    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                } catch { return null; }
            },

            // --- LOGIC ---
            async addDoc() {
                const pass = document.getElementById('master-pass').value;
                if (!pass) return alert("Нужен пароль!");
                
                const payload = {
                    fio: document.getElementById('new-fio').value,
                    num: document.getElementById('new-num').value
                };

                await db.docs.add({
                    type: document.getElementById('new-type').value,
                    data: this.encrypt(payload, pass)
                });

                document.getElementById('modal-add').style.display = 'none';
                this.renderGrid();
            },

            async renderGrid() {
                const pass = document.getElementById('master-pass').value;
                const container = document.getElementById('grid');
                container.innerHTML = '';

                const docs = await db.docs.toArray();

                docs.forEach(doc => {
                    const el = document.createElement('div');
                    el.className = 'doc-item';
                    
                    // Превью: Для паспорта обложка, для снилс - зеленая заглушка
                    const imgUrl = doc.type === 'passport' ? ASSETS.passport_cover : 'https://bafybeif47i434z7x6f4m2x7w23z5s7aovv52t2x7w23z5s7aovv.ipfs.w3s.link/snils-example.jpg';
                    
                    el.innerHTML = `<img src="${imgUrl}" loading="lazy">`;
                    
                    // Клик -> Открываем
                    el.onclick = () => this.openDoc(doc, pass);
                    container.appendChild(el);
                });
            },

            openDoc(doc, pass) {
                const data = this.decrypt(doc.data, pass);
                if (!data) return alert("Неверный пароль!");

                const viewer = document.getElementById('viewer');
                const bookContainer = document.getElementById('book');
                
                viewer.style.display = 'flex';
                bookContainer.innerHTML = ''; // Чистим старую книгу

                // 1. Настройка ATROPOS (эффект движения при наклоне)
                if (currentAtropos) currentAtropos.destroy();
                currentAtropos = Atropos({
                    el: '.my-atropos',
                    activeOffset: 40, // Насколько сильно двигается
                    shadowScale: 1.05,
                    rotateTouch: false, // ВАЖНО: отключаем вращение пальцем, чтобы можно было листать страницы!
                    rotateLock: false // ВАЖНО: разрешаем вращение от гироскопа телефона
                });

                // 2. Генерация страниц в зависимости от типа
                if (doc.type === 'passport') {
                    this.buildPassportBook(bookContainer, data);
                } else {
                    // Можно добавить логику для других доков
                    bookContainer.innerHTML = `<img src="https://bafybeif47i434z7x6f4m2x7w23z5s7aovv52t2x7w23z5s7aovv.ipfs.w3s.link/snils-example.jpg" style="width:100%; height:100%; border-radius:20px;">`;
                }
            },

            buildPassportBook(container, data) {
                // Создаем HTML структуру для page-flip
                // Стр 1: Обложка
                // Стр 2: Левая часть разворота (ФИО)
                // Стр 3: Правая часть разворота (Номер)
                // Стр 4: Задняя обложка

                const html = `
                    <div class="page --cover" data-density="hard">
                        <img src="${ASSETS.passport_cover}">
                    </div>
                    
                    <div class="page --left" data-density="hard">
                        <div style="width:100%; height:100%; overflow:hidden; position:relative;">
                            <img src="${ASSETS.passport_inside}" style="width:200%; max-width:none; transform: translateX(0);">
                            <div class="data-layer">
                                <div class="val val-fio">${data.fio}</div>
                            </div>
                        </div>
                    </div>

                    <div class="page --right" data-density="hard">
                         <div style="width:100%; height:100%; overflow:hidden; position:relative;">
                            <img src="${ASSETS.passport_inside}" style="width:200%; max-width:none; transform: translateX(-50%);">
                            <div class="data-layer">
                                <div class="val val-num">${data.num}</div>
                            </div>
                        </div>
                    </div>

                    <div class="page --cover" data-density="hard">
                        <img src="${ASSETS.passport_cover}">
                    </div>
                `;

                container.innerHTML = html;

                // 3. Инициализация PAGE-FLIP
                if (currentBook) currentBook.destroy();
                
                currentBook = new St.PageFlip(container, {
                    width: 350, // Ширина ОДНОЙ страницы
                    height: 500,
                    size: 'fixed',
                    minWidth: 350,
                    maxWidth: 350,
                    minHeight: 500,
                    maxHeight: 500,
                    showCover: true,
                    mobileScrollSupport: false // Чтобы не конфликтовало с Atropos
                });

                currentBook.loadFromHTML(document.querySelectorAll('.page'));
            },

            closeViewer() {
                document.getElementById('viewer').style.display = 'none';
                if (currentAtropos) currentAtropos.destroy();
            }
        };

        // Старт
        app.renderGrid();

    </script>
</body>
</html>
